name: Test Windows Build

on:
  push:
    branches: [ main, 'claude/**' ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run unit tests
      run: npm test

    - name: Build TypeScript
      run: npm run build

    - name: Package Windows app
      run: npm run package

    - name: Verify exe file exists
      shell: pwsh
      run: |
        $exePath = "release/win-unpacked/LoL Analytics Viewer.exe"
        if (!(Test-Path $exePath)) {
          Write-Error "‚ùå EXE file not found: $exePath"
          exit 1
        }

        $exeSize = (Get-Item $exePath).Length / 1MB
        Write-Output "‚úÖ EXE file exists: $([math]::Round($exeSize, 2)) MB"

        # „Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØÔºà100MBÊú™Ê∫Ä„ÅØÁï∞Â∏∏Ôºâ
        if ($exeSize -lt 100) {
          Write-Error "‚ùå EXE file too small: $([math]::Round($exeSize, 2)) MB < 100 MB"
          exit 1
        }

    - name: Verify required DLLs
      shell: pwsh
      run: |
        $requiredDlls = @(
          "release/win-unpacked/d3dcompiler_47.dll",
          "release/win-unpacked/libEGL.dll",
          "release/win-unpacked/libGLESv2.dll"
        )

        foreach ($dll in $requiredDlls) {
          if (!(Test-Path $dll)) {
            Write-Error "‚ùå Required DLL not found: $dll"
            exit 1
          }
          Write-Output "‚úÖ Found: $dll"
        }

    - name: Verify app.asar
      shell: pwsh
      run: |
        $asarPath = "release/win-unpacked/resources/app.asar"
        if (!(Test-Path $asarPath)) {
          Write-Error "‚ùå app.asar not found: $asarPath"
          exit 1
        }

        $asarSize = (Get-Item $asarPath).Length / 1KB
        Write-Output "‚úÖ app.asar exists: $([math]::Round($asarSize, 2)) KB"

        # „Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØÔºà10KBÊú™Ê∫Ä„ÅØÁï∞Â∏∏Ôºâ
        if ($asarSize -lt 10) {
          Write-Error "‚ùå app.asar too small: $([math]::Round($asarSize, 2)) KB"
          exit 1
        }

    - name: Test exe startup (basic smoke test)
      shell: pwsh
      timeout-minutes: 2
      run: |
        Write-Output "üß™ Testing if exe can be launched..."

        # „Éó„É≠„Çª„Çπ„Çí„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßËµ∑Âãï„Åó„ÄÅ„Åô„Åê„Å´ÁµÇ‰∫Ü
        $exePath = "release/win-unpacked/LoL Analytics Viewer.exe"
        $process = Start-Process -FilePath $exePath -PassThru -WindowStyle Hidden

        Start-Sleep -Seconds 3

        if ($process.HasExited) {
          Write-Error "‚ùå Process exited immediately (possible crash)"
          exit 1
        }

        Write-Output "‚úÖ Process started successfully"

        # „Éó„É≠„Çª„Çπ„ÇíÂÅúÊ≠¢
        Stop-Process -Id $process.Id -Force
        Write-Output "‚úÖ Smoke test passed"

    - name: Upload Windows build artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: windows-build-${{ github.sha }}
        path: release/win-unpacked/
        retention-days: 5
        compression-level: 9

    - name: Create build summary
      if: success()
      shell: pwsh
      run: |
        $exePath = "release/win-unpacked/LoL Analytics Viewer.exe"
        $exeSize = (Get-Item $exePath).Length / 1MB
        $asarPath = "release/win-unpacked/resources/app.asar"
        $asarSize = (Get-Item $asarPath).Length / 1KB

        $summary = @"
        ## ‚úÖ Windows Build Success

        - **EXE Size**: $([math]::Round($exeSize, 2)) MB
        - **app.asar Size**: $([math]::Round($asarSize, 2)) KB
        - **Commit**: ${{ github.sha }}
        - **Branch**: ${{ github.ref_name }}

        ### Verified Checks
        - ‚úÖ Unit tests passed
        - ‚úÖ TypeScript build successful
        - ‚úÖ EXE file created
        - ‚úÖ Required DLLs present
        - ‚úÖ app.asar valid
        - ‚úÖ Basic startup test passed

        Download the artifact to test on Windows!
        "@

        Write-Output $summary >> $env:GITHUB_STEP_SUMMARY
